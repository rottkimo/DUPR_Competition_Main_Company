<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é¸æ‰‹è³‡æ–™ç®¡ç†ï¼ˆv9.4.1ï¼šæ‰¹æ¬¡è²¼ä¸Šä¿®å¾©ï¼‹å¯ç·¨è¼¯ï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; max-width: 1000px; margin: auto; background:#f5f7fa; }
    .player-item { border: 1px solid #dee2e6; border-radius: .5rem; padding: 8px 12px; margin-bottom: 8px; background:#fff; display:flex; justify-content: space-between; align-items:center; box-shadow:0 4px 12px rgba(0,0,0,0.04);}
    .badge-id { font-weight:600; }
    .preview-box { background:#fff; border:1px dashed #999; padding:10px; border-radius:6px; }
    .small-mono { font-family: monospace; font-size:0.85em; }
    #previewListTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    #previewListTable th, #previewListTable td {
      padding: 6px 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    #previewListTable th {
      text-align: left;
      font-weight: 600;
    }
    .name-col { width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .id-col { width: 40%; text-align: left; }

    /* å°é½Šï¼šåå­—èˆ‡ 6 ç¢¼ ID ç·Šé„°å°é½Š */
    .player-item{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
    }
    .player-main{
      display:grid;
      grid-template-columns: 180px 7ch;
      align-items:center;
      gap: 8px;
      width:100%;
    }
    .player-name{
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .player-id.badge{
      text-align:left;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-weight:600;
      justify-self:start;
    }
    .player-actions .btn{ width:36px; min-width:36px; padding:4px 0; }
  </style>
</head>
<body>
  <h2 class="text-primary mb-4">ğŸ“ é¸æ‰‹è³‡æ–™ç®¡ç†ç³»çµ±ï¼ˆv9.4.1ï¼‰</h2>

  <div class="mb-3">
    <button class="btn btn-outline-dark" onclick="window.location.href='index.html'">ğŸ”™ å›åˆ°æ¯”è³½åˆ†æ•¸è¼¸å…¥é é¢</button>
  </div>

  <div class="mb-3">
    <label for="comboInput" class="form-label">ğŸ“‹ æ‰¹æ¬¡è²¼ä¸Šé¸æ‰‹è³‡æ–™ï¼ˆæ”¯æ´å„å¼åˆ†éš”èˆ‡ä¸­è‹±æ¨™é» / æ›è¡Œæ‹† ID è‡ªå‹•åˆä½µï¼‰ï¼š</label>
    <textarea class="form-control" id="comboInput" rows="6" placeholder='ä¾‹ï¼š
Jefféº’ / ZDQQDM
"CL YUAN","NXR2VN"
Simon , P5ZWRG
Huaï¼šE9DJMM
Saraã€€OZ56X7
èŠ±æ    ME5X0V
SHERRY\tGW0Y7G'></textarea>
    <div class="form-text">
      æ”¯æ´ï¼šé€—è™Ÿï¼ˆ,ï¼Œï¼‰ã€æ–œç·šï¼ˆ/ï¼ï¼‰ã€å†’è™Ÿï¼ˆ:ï¼šï¼‰ã€ç©ºç™½ï¼tabã€æ‹¬è™Ÿã€å¼•è™Ÿï¼›èƒ½è‡ªå‹•å»é™¤å‰å°æ™‚é–“æˆ³ï¼›è‹¥ ID å–®ç¨ä½”ä¸‹ä¸€è¡Œæœƒè‡ªå‹•åˆä½µã€‚
    </div>
  </div>

  <div class="mb-3">
    <button class="btn btn-primary me-2" onclick="parseComboInput()">â¬†ï¸ æ‰¹æ¬¡æ–°å¢é¸æ‰‹</button>
    <button class="btn btn-info" onclick="previewParsing()">ğŸ‘ é è¦½è§£æçµæœ</button>
  </div>

  <div class="mb-4" id="previewArea" style="display:none;">
    <div class="preview-box">
      <strong>é è¦½çµæœï¼ˆå°šæœªåŠ å…¥ï¼‰ï¼š</strong>
      <div id="previewList" class="mt-2"></div>
      <div class="form-text">ç¢ºèªæ²’å•é¡Œå¾Œï¼Œå†æŒ‰ã€Œâ¬†ï¸ æ‰¹æ¬¡æ–°å¢é¸æ‰‹ã€ã€‚</div>
    </div>
  </div>

  <div class="input-group mb-3">
    <input type="text" class="form-control" id="playerName" placeholder="åç¨± (name)">
    <input type="text" class="form-control" id="duprId" placeholder="DUPR ID">
    <button class="btn btn-success" onclick="addPlayer()">æ–°å¢é¸æ‰‹</button>
  </div>

  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <button class="btn btn-outline-info" onclick="exportCSV()">ğŸ“¤ åŒ¯å‡º CSV</button>
    <label class="btn btn-outline-primary mb-0">
      ğŸ“‚ åŒ¯å…¥ CSV <input type="file" id="csvFileInput" accept=".csv" onchange="importCSV(event)" hidden>
    </label>
    <div class="ms-auto w-50">
      <div class="input-group">
        <input type="password" class="form-control" id="adminPassword" placeholder="ç®¡ç†å“¡å¯†ç¢¼">
        <button class="btn btn-outline-secondary" onclick="togglePassword()">ğŸ‘</button>
        <button class="btn btn-danger" onclick="clearAllData()">âŒ æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <h5>ğŸ“ƒ é¸æ‰‹æ¸…å–®</h5>
    <div id="playerList"></div>
  </div>

  <!-- ç·¨è¼¯ Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ç·¨è¼¯é¸æ‰‹è³‡æ–™</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">é¸æ‰‹åç¨±</label>
            <input type="text" class="form-control" id="editName">
          </div>
          <div>
            <label class="form-label">DUPR IDï¼ˆ6 ç¢¼è‹±æ•¸ï¼‰</label>
            <input type="text" class="form-control" id="editDupr">
            <div class="form-text">å°‡è‡ªå‹•è½‰ç‚ºå¤§å¯«ä¸¦æª¢æŸ¥é‡è¤‡ã€‚</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let players = [];
    let editIndex = -1;
    let editModal;
    const validHashes = [
      "2cec8cf0e321c284fa0c2ebef804aac18bf1cbb85546f89e7e3d0b6aa8b9d2cf",
      "f457528f5880e850a162d62a3db51dda0f8c339434dd424b9781570aab5d4abb"
    ];

    window.onload = () => {
      const stored = localStorage.getItem('players');
      if (stored) { try { players = JSON.parse(stored); } catch(e){ players = []; } }
      renderPlayers();
      editModal = new bootstrap.Modal(document.getElementById('editModal'));
    };

    function saveToLocalStorage() { localStorage.setItem('players', JSON.stringify(players)); }
    function isDuplicate(duprId, ignoreIndex = -1) {
      const target = (duprId||'').toUpperCase();
      return players.some((p,i)=> (p.duprId||'').toUpperCase() === target && i!==ignoreIndex);
    }

    function renderPlayers() {
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'player-item';
        item.innerHTML = `
          <div class="player-main">
            <span class="player-name"><strong>${escapeHtml(player.name)}</strong></span>
            <span class="player-id badge bg-secondary badge-id">${escapeHtml(player.duprId)}</span>
          </div>
          <div class="player-actions d-flex gap-1">
            <button class="btn btn-sm btn-outline-secondary" title="ç·¨è¼¯" onclick="openEdit(${index})">âœï¸</button>
            <button class="btn btn-sm btn-outline-danger" title="åˆªé™¤" onclick="deletePlayer(${index})">ğŸ—‘ï¸</button>
          </div>`;
        list.appendChild(item);
      });
    }

    function addPlayer() {
      const name = document.getElementById('playerName').value.trim();
      let duprId = document.getElementById('duprId').value.trim().toUpperCase();
      if (!name || !duprId) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™');
      if (!/^[A-Z0-9]{6}$/.test(duprId)) return alert('DUPR ID éœ€ç‚º 6 ç¢¼è‹±æ•¸å­—');
      if (isDuplicate(duprId)) return alert('æ­¤é¸æ‰‹å·²å­˜åœ¨ï¼ˆDUPR ID é‡è¤‡ï¼‰');
      players.push({ name, duprId });
      saveToLocalStorage();
      renderPlayers();
      document.getElementById('playerName').value = '';
      document.getElementById('duprId').value = '';
    }

    function deletePlayer(index) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) {
        players.splice(index, 1);
        saveToLocalStorage();
        renderPlayers();
      }
    }

    // === ç·¨è¼¯ï¼ˆModalï¼‰ ===
    function openEdit(index) {
      editIndex = index;
      document.getElementById('editName').value = players[index].name;
      document.getElementById('editDupr').value = players[index].duprId;
      editModal.show();
    }
    function saveEdit() {
      if (editIndex < 0) return;
      const newName = document.getElementById('editName').value.trim();
      let newDupr = document.getElementById('editDupr').value.trim().toUpperCase();
      if (!newName) return alert('è«‹è¼¸å…¥é¸æ‰‹åç¨±');
      if (!/^[A-Z0-9]{6}$/.test(newDupr)) return alert('DUPR ID éœ€ç‚º 6 ç¢¼è‹±æ•¸å­—');
      if (isDuplicate(newDupr, editIndex)) return alert('æ­¤ DUPR ID å·²å­˜åœ¨ï¼Œè«‹æ›´æ›');
      players[editIndex].name = newName;
      players[editIndex].duprId = newDupr;
      saveToLocalStorage();
      renderPlayers();
      editModal.hide();
      editIndex = -1;
    }

    // === åŒ¯å…¥/åŒ¯å‡º ===
    function exportCSV() {
      if (players.length === 0) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºï¼");
      let csv = "name,duprId\n";
      players.forEach(p => csv += `"${p.name}","${p.duprId}"\n`);
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "players.csv";
      link.click();
    }
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n').filter(Boolean);
        lines.shift(); // drop header
        let added = 0;
        const exist = new Set(players.map(p => (p.duprId||'').toUpperCase()));
        lines.forEach(line => {
          const [nameRaw, duprRaw] = line.replace(/["']/g, '').split(',');
          const name = (nameRaw || '').trim();
          const duprId = ((duprRaw || '').trim()).toUpperCase();
          if (name && /^[A-Z0-9]{6}$/.test(duprId) && !exist.has(duprId)) {
            players.push({ name, duprId });
            exist.add(duprId);
            added++;
          }
        });
        saveToLocalStorage();
        renderPlayers();
        alert(`æˆåŠŸåŒ¯å…¥ ${added} ç­†æ–°é¸æ‰‹è³‡æ–™ï¼`);
      };
      reader.readAsText(file, 'utf-8');
    }

    async function hashString(str) {
      const utf8 = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    async function clearAllData() {
      const password = document.getElementById('adminPassword').value.trim();
      const hash = await hashString(password);
      if (validHashes.includes(hash)) {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")) {
          players = [];
          localStorage.removeItem('players');
          renderPlayers();
          alert("æ‰€æœ‰è³‡æ–™å·²åˆªé™¤ï¼");
        }
      } else {
        alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•åˆªé™¤ï¼");
      }
    }
    function togglePassword() {
      const pwdInput = document.getElementById('adminPassword');
      pwdInput.type = (pwdInput.type === 'password') ? 'text' : 'password';
    }

    // =====================
    // æ‰¹æ¬¡è²¼ä¸Šï¼šçµ±ä¸€è§£ææ ¸å¿ƒï¼ˆçµ¦ã€Œé è¦½ã€èˆ‡ã€Œæ–°å¢ã€å…±ç”¨ï¼‰
    // =====================
    function stripLeadingTimestamp(line) {
      return line.replace(/^\s*\d{1,2}:\d{2}(?::\d{2})?\s+/, '').trim();
    }
    function mergeBrokenLines(rawText) {
      const rawLines = rawText.replace(/\r\n/g,'\n').split('\n').map(l=>l.trim()).filter(Boolean);
      const merged = [];
      for (let i = 0; i < rawLines.length; i++) {
        // è‹¥ä¸‹ä¸€è¡Œæ˜¯ 6 ç¢¼ IDï¼Œå‰‡èˆ‡æœ¬è¡Œåˆä½µ
        if (i < rawLines.length - 1 && /^[A-Za-z0-9]{6}$/.test(rawLines[i + 1])) {
          merged.push(`${rawLines[i]} ${rawLines[i+1]}`);
          i++;
        } else {
          merged.push(rawLines[i]);
        }
      }
      return merged;
    }
    function cleanQuotes(s) { return (s||'').replace(/^[â€œâ€"']+|[â€œâ€"']+$/g,''); }
    function normalizePunct(s){
      return (s||'')
        .replace(/[ï¼Œ]/g, ',')
        .replace(/[ï¼š]/g, ':')
        .replace(/[ï¼]/g, '/')
        .replace(/\t/g, ' ')
        .replace(/\s{2,}/g, ' ');
    }
    function cleanName(rawName) {
      let name = (rawName||'').trim();
      name = cleanQuotes(name);
      if (name === '') return null;
      return name;
    }
    function parseLineFlexible(line){
      // çµ±ä¸€æ¨™é»
      let L = normalizePunct(stripLeadingTimestamp(line));
      if (!L) return null;

      // 1) CSV é¢¨ï¼ˆå«å¼•è™Ÿï¼‰
      let m = L.match(/^\s*"([^"]+)"\s*,\s*"([A-Za-z0-9]{6})"\s*$/);
      if (m) return { name: cleanName(m[1]), duprId: m[2].toUpperCase() };

      // 2) é€—è™Ÿåˆ†éš”
      if (L.includes(',')){
        const parts = L.split(',').map(p=>cleanQuotes(p.trim()));
        if (parts.length >= 2){
          const name = cleanName(parts[0]);
          const id = (parts[1]||'').toUpperCase();
          if (name && /^[A-Z0-9]{6}$/.test(id)) return { name, duprId: id };
        }
      }

      // 3) å†’è™Ÿ / æ–œç·š / ç©ºç™½åˆ†éš”ï¼ˆå–æœ€å¾Œ 6 ç¢¼ç‚º IDï¼Œå‰é¢ç‚ºåç¨±ï¼‰
      let U = L.toUpperCase();
      const ids = U.match(/[A-Z0-9]{6}/g);
      if (ids && ids.length){
        const lastId = ids[ids.length - 1];
        const pos = U.lastIndexOf(lastId);
        if (pos >= 0){
          const name = cleanName(L.slice(0,pos).replace(/[\s/,:-]+$/,'').trim());
          if (name) return { name, duprId: lastId };
        }
      }

      // 4) æ‹¬è™Ÿæ¨£å¼ï¼šName (ID)
      m = L.match(/^(.+?)\s*\(\s*([A-Za-z0-9]{6})\s*\)$/);
      if (m) return { name: cleanName(m[1]), duprId: m[2].toUpperCase() };

      // 5) åå‘ï¼šID é–‹é ­
      m = L.match(/^([A-Za-z0-9]{6})[\s/,:-]+(.+)$/);
      if (m) return { name: cleanName(m[2]), duprId: m[1].toUpperCase() };

      return null;
    }
    function parseBulk(raw){
      const merged = mergeBrokenLines(raw);
      const results = [];
      const seen = new Set(); // å»é‡åŒä¸€æ‰¹çš„ ID
      merged.forEach(line => {
        const parsed = parseLineFlexible(line);
        if (parsed && parsed.name && /^[A-Z0-9]{6}$/.test(parsed.duprId)){
          const idU = parsed.duprId.toUpperCase();
          if (!seen.has(idU)){
            results.push({ name: parsed.name, duprId: idU });
            seen.add(idU);
          }
        }
      });
      return results;
    }

    // === é è¦½èˆ‡æ–°å¢å…±ç”¨ ===
    function previewParsing() {
      const raw = document.getElementById('comboInput').value || '';
      const parsed = parseBulk(raw);
      const previewList = document.getElementById('previewList');
      previewList.innerHTML = '';
      if (parsed.length === 0) {
        previewList.innerHTML = '<div class="text-muted">æ‰¾ä¸åˆ°å¯è§£æçš„æœ‰æ•ˆé…å°</div>';
      } else {
        const table = document.createElement('table');
        table.id = 'previewListTable';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th class="name-col">åç¨±</th><th class="id-col">DUPR ID</th></tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        parsed.forEach(p => {
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td'); nameTd.className='name-col'; nameTd.textContent = p.name;
          const idTd = document.createElement('td'); idTd.className='id-col'; idTd.textContent = p.duprId;
          tr.appendChild(nameTd); tr.appendChild(idTd); tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        previewList.appendChild(table);
      }
      document.getElementById('previewArea').style.display = 'block';
    }

    function parseComboInput() {
      const raw = document.getElementById('comboInput').value || '';
      const parsed = parseBulk(raw);
      if (parsed.length === 0) return alert('æ²’æœ‰å¯æ–°å¢çš„è³‡æ–™ã€‚è«‹ç¢ºèªæ ¼å¼ã€‚');

      const existing = new Set(players.map(p => (p.duprId||'').toUpperCase()));
      let added = 0, skippedDuplicate = 0;
      parsed.forEach(p => {
        const idU = (p.duprId||'').toUpperCase();
        if (!existing.has(idU)) {
          players.push({ name: p.name, duprId: idU });
          existing.add(idU);
          added++;
        } else {
          skippedDuplicate++;
        }
      });
      saveToLocalStorage();
      renderPlayers();
      document.getElementById('comboInput').value = '';
      document.getElementById('previewArea').style.display='none';

      alert(`æ‰¹æ¬¡æ–°å¢å®Œæˆï¼šæ–°å¢ ${added} ç­†ï¼Œé‡è¤‡è·³é ${skippedDuplicate} ç­†ã€‚`);
    }

    // å®‰å…¨è¼¸å‡º
    function escapeHtml(str){ return (str ?? '').toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  </script>
</body>
</html>
