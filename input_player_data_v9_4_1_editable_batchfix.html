<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>選手資料管理（v9.4.1：批次貼上修復＋可編輯）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; max-width: 1000px; margin: auto; background:#f5f7fa; }
    .player-item { border: 1px solid #dee2e6; border-radius: .5rem; padding: 8px 12px; margin-bottom: 8px; background:#fff; display:flex; justify-content: space-between; align-items:center; box-shadow:0 4px 12px rgba(0,0,0,0.04);}
    .badge-id { font-weight:600; }
    .preview-box { background:#fff; border:1px dashed #999; padding:10px; border-radius:6px; }
    .small-mono { font-family: monospace; font-size:0.85em; }
    #previewListTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    #previewListTable th, #previewListTable td {
      padding: 6px 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    #previewListTable th {
      text-align: left;
      font-weight: 600;
    }
    .name-col { width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .id-col { width: 40%; text-align: left; }

    /* 對齊：名字與 6 碼 ID 緊鄰對齊 */
    .player-item{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
    }
    .player-main{
      display:grid;
      grid-template-columns: 180px 7ch;
      align-items:center;
      gap: 8px;
      width:100%;
    }
    .player-name{
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .player-id.badge{
      text-align:left;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-weight:600;
      justify-self:start;
    }
    .player-actions .btn{ width:36px; min-width:36px; padding:4px 0; }
  </style>
</head>
<body>
  <h2 class="text-primary mb-4">🏓 選手資料管理系統（v9.4.1）</h2>

  <div class="mb-3">
    <button class="btn btn-outline-dark" onclick="window.location.href='index.html'">🔙 回到比賽分數輸入頁面</button>
  </div>

  <div class="mb-3">
    <label for="comboInput" class="form-label">📋 批次貼上選手資料（支援各式分隔與中英標點 / 換行拆 ID 自動合併）：</label>
    <textarea class="form-control" id="comboInput" rows="6" placeholder='例：
Jeff麒 / ZDQQDM
"CL YUAN","NXR2VN"
Simon , P5ZWRG
Hua：E9DJMM
Sara　OZ56X7
花枝    ME5X0V
SHERRY\tGW0Y7G'></textarea>
    <div class="form-text">
      支援：逗號（,，）、斜線（/／）、冒號（:：）、空白／tab、括號、引號；能自動去除前導時間戳；若 ID 單獨佔下一行會自動合併。
    </div>
  </div>

  <div class="mb-3">
    <button class="btn btn-primary me-2" onclick="parseComboInput()">⬆️ 批次新增選手</button>
    <button class="btn btn-info" onclick="previewParsing()">👁 預覽解析結果</button>
  </div>

  <div class="mb-4" id="previewArea" style="display:none;">
    <div class="preview-box">
      <strong>預覽結果（尚未加入）：</strong>
      <div id="previewList" class="mt-2"></div>
      <div class="form-text">確認沒問題後，再按「⬆️ 批次新增選手」。</div>
    </div>
  </div>

  <div class="input-group mb-3">
    <input type="text" class="form-control" id="playerName" placeholder="名稱 (name)">
    <input type="text" class="form-control" id="duprId" placeholder="DUPR ID">
    <button class="btn btn-success" onclick="addPlayer()">新增選手</button>
  </div>

  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <button class="btn btn-outline-info" onclick="exportCSV()">📤 匯出 CSV</button>
    <label class="btn btn-outline-primary mb-0">
      📂 匯入 CSV <input type="file" id="csvFileInput" accept=".csv" onchange="importCSV(event)" hidden>
    </label>
    <div class="ms-auto w-50">
      <div class="input-group">
        <input type="password" class="form-control" id="adminPassword" placeholder="管理員密碼">
        <button class="btn btn-outline-secondary" onclick="togglePassword()">👁</button>
        <button class="btn btn-danger" onclick="clearAllData()">❌ 清除全部資料</button>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <h5>📃 選手清單</h5>
    <div id="playerList"></div>
  </div>

  <!-- 編輯 Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">編輯選手資料</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">選手名稱</label>
            <input type="text" class="form-control" id="editName">
          </div>
          <div>
            <label class="form-label">DUPR ID（6 碼英數）</label>
            <input type="text" class="form-control" id="editDupr">
            <div class="form-text">將自動轉為大寫並檢查重複。</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let players = [];
    let editIndex = -1;
    let editModal;
    const validHashes = [
      "2cec8cf0e321c284fa0c2ebef804aac18bf1cbb85546f89e7e3d0b6aa8b9d2cf",
      "f457528f5880e850a162d62a3db51dda0f8c339434dd424b9781570aab5d4abb"
    ];

    window.onload = () => {
      const stored = localStorage.getItem('players');
      if (stored) { try { players = JSON.parse(stored); } catch(e){ players = []; } }
      renderPlayers();
      editModal = new bootstrap.Modal(document.getElementById('editModal'));
    };

    function saveToLocalStorage() { localStorage.setItem('players', JSON.stringify(players)); }
    function isDuplicate(duprId, ignoreIndex = -1) {
      const target = (duprId||'').toUpperCase();
      return players.some((p,i)=> (p.duprId||'').toUpperCase() === target && i!==ignoreIndex);
    }

    function renderPlayers() {
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'player-item';
        item.innerHTML = `
          <div class="player-main">
            <span class="player-name"><strong>${escapeHtml(player.name)}</strong></span>
            <span class="player-id badge bg-secondary badge-id">${escapeHtml(player.duprId)}</span>
          </div>
          <div class="player-actions d-flex gap-1">
            <button class="btn btn-sm btn-outline-secondary" title="編輯" onclick="openEdit(${index})">✏️</button>
            <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="deletePlayer(${index})">🗑️</button>
          </div>`;
        list.appendChild(item);
      });
    }

    function addPlayer() {
      const name = document.getElementById('playerName').value.trim();
      let duprId = document.getElementById('duprId').value.trim().toUpperCase();
      if (!name || !duprId) return alert('請輸入完整資料');
      if (!/^[A-Z0-9]{6}$/.test(duprId)) return alert('DUPR ID 需為 6 碼英數字');
      if (isDuplicate(duprId)) return alert('此選手已存在（DUPR ID 重複）');
      players.push({ name, duprId });
      saveToLocalStorage();
      renderPlayers();
      document.getElementById('playerName').value = '';
      document.getElementById('duprId').value = '';
    }

    function deletePlayer(index) {
      if (confirm("確定要刪除這筆資料嗎？")) {
        players.splice(index, 1);
        saveToLocalStorage();
        renderPlayers();
      }
    }

    // === 編輯（Modal） ===
    function openEdit(index) {
      editIndex = index;
      document.getElementById('editName').value = players[index].name;
      document.getElementById('editDupr').value = players[index].duprId;
      editModal.show();
    }
    function saveEdit() {
      if (editIndex < 0) return;
      const newName = document.getElementById('editName').value.trim();
      let newDupr = document.getElementById('editDupr').value.trim().toUpperCase();
      if (!newName) return alert('請輸入選手名稱');
      if (!/^[A-Z0-9]{6}$/.test(newDupr)) return alert('DUPR ID 需為 6 碼英數字');
      if (isDuplicate(newDupr, editIndex)) return alert('此 DUPR ID 已存在，請更換');
      players[editIndex].name = newName;
      players[editIndex].duprId = newDupr;
      saveToLocalStorage();
      renderPlayers();
      editModal.hide();
      editIndex = -1;
    }

    // === 匯入/匯出 ===
    function exportCSV() {
      if (players.length === 0) return alert("目前沒有資料可匯出！");
      let csv = "name,duprId\n";
      players.forEach(p => csv += `"${p.name}","${p.duprId}"\n`);
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "players.csv";
      link.click();
    }
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n').filter(Boolean);
        lines.shift(); // drop header
        let added = 0;
        const exist = new Set(players.map(p => (p.duprId||'').toUpperCase()));
        lines.forEach(line => {
          const [nameRaw, duprRaw] = line.replace(/["']/g, '').split(',');
          const name = (nameRaw || '').trim();
          const duprId = ((duprRaw || '').trim()).toUpperCase();
          if (name && /^[A-Z0-9]{6}$/.test(duprId) && !exist.has(duprId)) {
            players.push({ name, duprId });
            exist.add(duprId);
            added++;
          }
        });
        saveToLocalStorage();
        renderPlayers();
        alert(`成功匯入 ${added} 筆新選手資料！`);
      };
      reader.readAsText(file, 'utf-8');
    }

    async function hashString(str) {
      const utf8 = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    async function clearAllData() {
      const password = document.getElementById('adminPassword').value.trim();
      const hash = await hashString(password);
      if (validHashes.includes(hash)) {
        if (confirm("確定要清除所有資料？")) {
          players = [];
          localStorage.removeItem('players');
          renderPlayers();
          alert("所有資料已刪除！");
        }
      } else {
        alert("密碼錯誤，無法刪除！");
      }
    }
    function togglePassword() {
      const pwdInput = document.getElementById('adminPassword');
      pwdInput.type = (pwdInput.type === 'password') ? 'text' : 'password';
    }

    // =====================
    // 批次貼上：統一解析核心（給「預覽」與「新增」共用）
    // =====================
    function stripLeadingTimestamp(line) {
      return line.replace(/^\s*\d{1,2}:\d{2}(?::\d{2})?\s+/, '').trim();
    }
    function mergeBrokenLines(rawText) {
      const rawLines = rawText.replace(/\r\n/g,'\n').split('\n').map(l=>l.trim()).filter(Boolean);
      const merged = [];
      for (let i = 0; i < rawLines.length; i++) {
        // 若下一行是 6 碼 ID，則與本行合併
        if (i < rawLines.length - 1 && /^[A-Za-z0-9]{6}$/.test(rawLines[i + 1])) {
          merged.push(`${rawLines[i]} ${rawLines[i+1]}`);
          i++;
        } else {
          merged.push(rawLines[i]);
        }
      }
      return merged;
    }
    function cleanQuotes(s) { return (s||'').replace(/^[“”"']+|[“”"']+$/g,''); }
    function normalizePunct(s){
      return (s||'')
        .replace(/[，]/g, ',')
        .replace(/[：]/g, ':')
        .replace(/[／]/g, '/')
        .replace(/\t/g, ' ')
        .replace(/\s{2,}/g, ' ');
    }
    function cleanName(rawName) {
      let name = (rawName||'').trim();
      name = cleanQuotes(name);
      if (name === '') return null;
      return name;
    }
    function parseLineFlexible(line){
      // 統一標點
      let L = normalizePunct(stripLeadingTimestamp(line));
      if (!L) return null;

      // 1) CSV 風（含引號）
      let m = L.match(/^\s*"([^"]+)"\s*,\s*"([A-Za-z0-9]{6})"\s*$/);
      if (m) return { name: cleanName(m[1]), duprId: m[2].toUpperCase() };

      // 2) 逗號分隔
      if (L.includes(',')){
        const parts = L.split(',').map(p=>cleanQuotes(p.trim()));
        if (parts.length >= 2){
          const name = cleanName(parts[0]);
          const id = (parts[1]||'').toUpperCase();
          if (name && /^[A-Z0-9]{6}$/.test(id)) return { name, duprId: id };
        }
      }

      // 3) 冒號 / 斜線 / 空白分隔（取最後 6 碼為 ID，前面為名稱）
      let U = L.toUpperCase();
      const ids = U.match(/[A-Z0-9]{6}/g);
      if (ids && ids.length){
        const lastId = ids[ids.length - 1];
        const pos = U.lastIndexOf(lastId);
        if (pos >= 0){
          const name = cleanName(L.slice(0,pos).replace(/[\s/,:-]+$/,'').trim());
          if (name) return { name, duprId: lastId };
        }
      }

      // 4) 括號樣式：Name (ID)
      m = L.match(/^(.+?)\s*\(\s*([A-Za-z0-9]{6})\s*\)$/);
      if (m) return { name: cleanName(m[1]), duprId: m[2].toUpperCase() };

      // 5) 反向：ID 開頭
      m = L.match(/^([A-Za-z0-9]{6})[\s/,:-]+(.+)$/);
      if (m) return { name: cleanName(m[2]), duprId: m[1].toUpperCase() };

      return null;
    }
    function parseBulk(raw){
      const merged = mergeBrokenLines(raw);
      const results = [];
      const seen = new Set(); // 去重同一批的 ID
      merged.forEach(line => {
        const parsed = parseLineFlexible(line);
        if (parsed && parsed.name && /^[A-Z0-9]{6}$/.test(parsed.duprId)){
          const idU = parsed.duprId.toUpperCase();
          if (!seen.has(idU)){
            results.push({ name: parsed.name, duprId: idU });
            seen.add(idU);
          }
        }
      });
      return results;
    }

    // === 預覽與新增共用 ===
    function previewParsing() {
      const raw = document.getElementById('comboInput').value || '';
      const parsed = parseBulk(raw);
      const previewList = document.getElementById('previewList');
      previewList.innerHTML = '';
      if (parsed.length === 0) {
        previewList.innerHTML = '<div class="text-muted">找不到可解析的有效配對</div>';
      } else {
        const table = document.createElement('table');
        table.id = 'previewListTable';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th class="name-col">名稱</th><th class="id-col">DUPR ID</th></tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        parsed.forEach(p => {
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td'); nameTd.className='name-col'; nameTd.textContent = p.name;
          const idTd = document.createElement('td'); idTd.className='id-col'; idTd.textContent = p.duprId;
          tr.appendChild(nameTd); tr.appendChild(idTd); tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        previewList.appendChild(table);
      }
      document.getElementById('previewArea').style.display = 'block';
    }

    function parseComboInput() {
      const raw = document.getElementById('comboInput').value || '';
      const parsed = parseBulk(raw);
      if (parsed.length === 0) return alert('沒有可新增的資料。請確認格式。');

      const existing = new Set(players.map(p => (p.duprId||'').toUpperCase()));
      let added = 0, skippedDuplicate = 0;
      parsed.forEach(p => {
        const idU = (p.duprId||'').toUpperCase();
        if (!existing.has(idU)) {
          players.push({ name: p.name, duprId: idU });
          existing.add(idU);
          added++;
        } else {
          skippedDuplicate++;
        }
      });
      saveToLocalStorage();
      renderPlayers();
      document.getElementById('comboInput').value = '';
      document.getElementById('previewArea').style.display='none';

      alert(`批次新增完成：新增 ${added} 筆，重複跳過 ${skippedDuplicate} 筆。`);
    }

    // 安全輸出
    function escapeHtml(str){ return (str ?? '').toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  </script>
</body>
</html>
